\documentclass{scrreprt}
\usepackage[shellescape]{gmp}
\usepackage{enumitem}
\begin{document}

    \chapter{Wayside Controller}
    \section{Use Cases}

    \begin{center}
        \resizebox{!}{.8\textheight}{
            \begin{mpost}
                input metauml;
                vardef drawComponentVisualStereotype(text ne)= relax enddef;
                Actor.ctc("CTC");
                Actor.weng("Wayside", "Engineer");
                Actor.simuser("Simulation", "User");
                %======== CTC Uses =========
                Usecase.uGetOcc      ("Get Occupancy");
                Usecase.uGetStatus   ("Get Block Status");
                Usecase.uGetSig      ("Get Signal");
                Usecase.uGetCross    ("Get Crossing");
                Usecase.uGetSwitch   ("Get Switch State");
                Usecase.uSetStatus   ("Set Block Status");
                Usecase.uToggleSwitch("Toggle Switch");
                Usecase.uSuggest     ("Suggest Speed", "& Authority");
                %======== Wayside Engineer Uses =========
                Usecase.uPLC("Upload PLC");
                %======== simuser Uses =========
                Usecase.uManSuggest("Manual Suggestion");
                Usecase.uViewData("View Track State");
                Usecase.uMultWindow("Open Multiple", "Windows");
                %======== This Component? =========
                Component.Wayside("WaysideController")(
                    uGetOcc,
                    uGetStatus,
                    uGetSig,
                    uGetCross,
                    uGetSwitch,
                    uSetStatus,
                    uToggleSwitch,
                    uSuggest,
                    uPLC,
                    uManSuggest,
                    uViewData,
                    uMultWindow
                );
                %======== CTC use cases ========
                topToBottom.left(10)(
                    uGetOcc,
                    uGetStatus,
                    uGetSig,
                    uGetCross,
                    uGetSwitch,
                    uSetStatus,
                    uToggleSwitch,
                    uSuggest
                );
                leftToRight(25)(ctc, uGetCross);
                %======== WaysideEngineer/simuser use cases ========
                topToBottom.right(10)(
                    uManSuggest,
                    uViewData,
                    uMultWindow
                );
                leftToRight(70)(uGetOcc, uPLC);
                leftToRight(25)(uPLC, weng);
                leftToRight(25)(uViewData, simuser);
                topToBottom(100)(weng, simuser);
                %======== Draw that shit!! ========
                drawObjects(
                    ctc,weng,simuser,WaysideController,
                    uGetOcc,
                    uGetStatus,
                    uGetSig,
                    uGetCross,
                    uGetSwitch,
                    uSetStatus,
                    uToggleSwitch,
                    uSuggest,
                    uPLC,
                    uManSuggest,
                    uViewData,
                    uMultWindow
                );
                %======== CTC Lines ========
                link(association)(pathCut(ctc, uGetOcc)      (ctc.e -- uGetOcc.w));
                link(association)(pathCut(ctc, uGetStatus)   (ctc.e -- uGetStatus.w));
                link(association)(pathCut(ctc, uGetSig)      (ctc.e -- uGetSig.w));
                link(association)(pathCut(ctc, uGetCross)    (ctc.e -- uGetCross.w));
                link(association)(pathCut(ctc, uGetSwitch)   (ctc.e -- uGetSwitch.w));
                link(association)(pathCut(ctc, uSetStatus)   (ctc.e -- uSetStatus.w));
                link(association)(pathCut(ctc, uToggleSwitch)(ctc.e -- uToggleSwitch.w));
                link(association)(pathCut(ctc, uSuggest)     (ctc.e -- uSuggest.w));
                %======== WaysdideEng Lines ========
                link(association)(pathCut(weng, uPLC)(weng.w -- uPLC.e));
                %======== simuser Lines ========
                link(association)(pathCut(simuser, uManSuggest)(simuser.w -- uManSuggest.e));
                link(association)(pathCut(simuser, uViewData)(simuser.w -- uViewData.e));
                link(association)(pathCut(simuser, uMultWindow)(simuser.w -- uMultWindow.e));
            \end{mpost}
        }
    \end{center}

\providecommand{\use}[1]{\subsection{Use Case: #1}}

    %========= CTC User Stories ========
    \use{Get Occupancy}
    \begin{enumerate}
        \item CTC calls ``isOccupied()'' with the proper block ID.
        \item WC returns true if block is occupied, false otherwise.
    \end{enumerate}

    \use{Get Block Status}
    \begin{enumerate}
        \item CTC calls ``getBlockStatus()'' with the proper block ID.
        \item WC returns one of ``OPERATIONAL'', ``BROKEN'', ``REPAIR''.
    \end{enumerate}

    \use{Get Signal}
    \begin{enumerate}
        \item CTC calls ``getSignal()'' with the proper block ID.
        \item WC returns true if signal is active, false otherwise.
    \end{enumerate}

    \use{Get Crossing}
    \begin{enumerate}
        \item CTC calls ``getCrossing()'' with the proper block ID.
        \item WC returns true if railroad crossing is active, false otherwise.
    \end{enumerate}

    \use{Get Switch State}
    \begin{enumerate}
        \item CTC calls ``getSwtich()'' with the proper block ID.
        \item WC returns true if switch is in active position, false otherwise.
    \end{enumerate}

    \use{Set Block Status}
    \begin{enumerate}
        \item CTC calls ``setBlockStatus()'' with the proper block ID, and the desired state.
        \item WC sends signal to TrackModel to set the status of the block with the given ID to the desired state.
        \item WC then returns the actual status of the block after assignment.
    \end{enumerate}

    \use{Toggle Switch State}
    \begin{enumerate}
        \item CTC calls ``toggleSwitch()'' with the proper block ID.
        \item WC validates this is safe.
        \item WC sends signal to TrackModel to toggle specified switch.
        \item WC then returns switch position.
    \end{enumerate}
    \subsubsection{Variant: Unsafe Toggle}
    \begin{enumerate}[label=3\alph*.]
        \item If WC fails to validate that this is safe, it does not send this message to TrackModel.
    \end{enumerate}

    \use{Suggest Speed \& Authority}
    \begin{enumerate}
        \item CTC calls ``suggest()'' with suggestion encoded in the proper format.
        \item WC validates that this input is safe.
        \item WC then sends the following to TrackModel:
            \begin{itemize}
                \item The given speed and authority.
                \item The position of switches necessary for this route.
                \item Activates any crossings necessary for this route.
                \item The state of all signals necessary for this route.
            \end{itemize}
    \end{enumerate}

    \subsubsection{Variant: Unsafe Suggestion}
    \begin{enumerate}[label=\arabic*a., start=3]
        \item If WC does not find this suggestion to be safe, then it will instead send the following to the TrackModel:
            \begin{itemize}
                \item No authority to all blocks.
                \item 0 speed to all blocks.
                \item Deactivates all crossing which are not currently occupied.
                \item Deactivates all signals.
            \end{itemize}
    \end{enumerate}

    %========== Wayside Users =========
    \use{Upload PLC}
    \begin{enumerate}
        \item Wayside Engineer (WE) pushes ``Upload PLC'' button.
        \item A File Chooser popup appears.
        \item WE chooses desired file.
        \item Popup appears stating PLC has successfully been uploaded.
    \end{enumerate}
    \subsubsection{Variant: Unable to Read File}
    \begin{enumerate}[label = \arabic*a., start = 4]
        \item If the selected file cannot be read for any reason, then a popup will appear reporting the error.
    \end{enumerate}
    \subsubsection{Variant: Invalid PLC}
    \begin{enumerate}[label = \arabic*b., start = 4]
        \item If the selected file does not contain valid PLC code, then a popup will appear reporting the error.
    \end{enumerate}

    %========== Sim User ===========
    \use{Manually Suggest Speed \& Authority}
    \begin{enumerate}
        \item Simulation User (SU) suggestion into table of the GUI, as per the Users' Manual.
        \item SU then hits the ``Submit'' button.
        \item WC reads this information, and verifies that the suggestion is safe.
        \item WC then sends the following to TrackModel:
        \begin{itemize}
            \item The given speed and authority.
            \item The position of switches necessary for this route.
            \item Activates any crossings necessary for this route.
            \item The state of all signals necessary for this route.
        \end{itemize}
    \end{enumerate}
    \subsubsection{Variant: Unsafe Suggestion}
    \begin{enumerate}[label=\arabic*a., start=4]
        \item If WC does not find this suggestion to be safe, then it will instead send the following to the TrackModel:
            \begin{itemize}
                \item No authority to all blocks.
                \item 0 speed to all blocks.
                \item Deactivates all crossing which are not currently occupied.
                \item Deactivates all signals.
            \end{itemize}
    \end{enumerate}

    \use{View Track State}
    \begin{enumerate}
        \item An automatically updating table of track state will be visible in the WC window.
    \end{enumerate}

    \use{Open Multiple Wayside Contolle Windows}
    \begin{enumerate}
        \item SU pushes the ``Open Wayside'' button.
        \item A popup with a text field appears.
        \item SU enters a block ID into this field, and hits the ``Open'' button.
        \item A new WC window appears representing the controller which has control over the given block.
    \end{enumerate}
    \subsubsection{Variant: Invalid Block}
    \begin{enumerate}[label = \arabic*a., start = 4]
        \item If SU enters an invalid block ID, then a popup will appear reporting the error.
    \end{enumerate}

    \section{Class Diagram}
    
    \begin{center}
    \resizebox{.9\textwidth}{!}{
        \begin{mpost}
            input metauml;

            Class.WaysideController("WaysideController")()(
                "static void init()",
                "static void init(String[])",
                "boolean getSignal(int blockId)",
                "boolean getSwitch(int blockId)",
                "boolean getCrossing(int blockId)",
                "boolean isOccupied(int blockId)",
                "BlockStatus getStatus(int blockId)",
                "boolean toggleSwitch(int blockId)",
                "void suggest(List<Suggestion>)"
            );
            
            Class.Compiler("Compiler")()(
                "Instruction[] compile(String code)",
            );
            
            Class.VirtualMachine("VirtualMachine")()(
                "void load(Instruction[] program)",
                "void run()"
            );
           
            Class.View("View")()(
                "boolean getSignal(int blockId)",
                "boolean getSwitch(int blockId)",
                "boolean getCrossing(int blockId)",
                "boolean isOccupied(int blockId)",
                "BlockStatus getStatus(int blockId)",
                "boolean getAuthority(blockId)",
                "int getSpeed(int blockId)",
                "boolean setSignal(int blockId, boolean value)",
                "boolean setSwitch(int blockId, boolean value)",
                "boolean setCrossing(int blockId, boolean value)",
                "boolean setOccupancy(int blockId, boolean value)",
                "BlockStatus setStatus(int blockId, BlockStatus value)",
                "boolean setAuthority(int blockId, boolean value)",
                "int setSpeed(int blockId, int value)",
                "boolean show()"
            );

            Class.RegFile("RegFile")()(
                "boolean read(Register reg)",
                "boolean write(Register reg, boolean value)"
            );

            Class.Instruction("Instruction")(
                "int operation",
                "Register src1",
                "Register src2",
                "Register dest",
                "int target"
            )();

            %=========== Now to actually lay it aht! ===========
            topToBottom(40)(View, Compiler, Instruction);
            leftToRight(30)(WaysideController, View);
            VirtualMachine.n = WaysideController.s + (0, -60);
            RegFile.n = VirtualMachine.s + (0, -60);
            
            drawObjects(WaysideController, Compiler, VirtualMachine, View, Instruction, RegFile);
            
            % WaysideController -> VirtualMachine 1..1 
            link(associationUni)(WaysideController.s -- VirtualMachine.n);
            
            % VirtualMachine -> Instruction 1..*
            link(compositionUni)(Instruction.nw -- VirtualMachine.se);
            item(iAssoc)("*")(obj.nw = Instruction.nw + (-16, 17));
            item(iAssoc)("1")(obj.nw = VirtualMachine.se + (12, 7));
            
            % VirtualMachine -> RegFile 1..1
            link(associationUni)(VirtualMachine.s -- RegFile.n);
            
            % WaysideController -> Compiler 1..1
            link(associationUni)(WaysideController.s + (20, 0) -- Compiler.nw);
            
            % WaysideController -> View 1..1
            link(associationUni)(WaysideController.e -- View.w);
        \end{mpost}
    }
    \end{center}
\end{document}