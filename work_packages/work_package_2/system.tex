\documentclass{scrreprt}
\usepackage[shellescape]{gmp}
\usepackage{listings}
\usepackage{underscore}
\usepackage[bookmarks=true]{hyperref}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{tikz}
\usepackage{pgf-umlsd}

%%%%%% header and footer info
\pagestyle{fancy}
\fancyhf{}
\rhead{System Use Case, Class, and Sequence Diagrams}
\lhead{Training Montage}
\cfoot{\thepage}

%%%%%% custom list definition
\newlist{numonly}{enumerate}{10}
\setlist[numonly]{label*=\arabic*.}

\hypersetup{
    pdftitle={CTC Model Use Case, Class, and Sequence Diagrams},    % title
    pdfauthor={Training Montage},                     % author
    pdfsubject={TeX and LaTeX},                        % subject of the document
    pdfkeywords={TeX, LaTeX, graphics, images}, % list of keywords
    colorlinks=true,       % false: boxed links; true: colored links
    linkcolor=blue,       % color of internal links
    citecolor=black,       % color of links to bibliography
    filecolor=black,        % color of file links
    urlcolor=purple,        % color of external links
    linktoc=page            % only page is linked
}

\begin{document}

\begin{flushright}
    \rule{16cm}{5pt}\vskip1cm
    \begin{bfseries}
        \Huge{SYSTEM USE CASE, CLASS, AND SEQUENCE DIAGRAMS}\\
        \vspace{.9cm}
        for\\
        \vspace{.9cm}
        COE 1186 Project\\
        \vspace{.9cm}
        % \LARGE{Version \myversion approved}\\
        \vspace{.9cm}
        Prepared by:\\
        Alec Rosenbaum\\
        Aric Hudson\\
        Isaac Goss\\
        Mitch Moran\\
	    Parth Dadhania\\
        \vspace{1.9cm}
        Training Montage\\
        \vspace{.9cm}
        \today\\
    \end{bfseries}
\end{flushright}

\tableofcontents

\chapter{System Architecture}

\section{Use Cases}

\begin{center}
\resizebox{!}{.8\textheight}{
	\begin{mpost}
	    input metauml;
	    vardef drawComponentVisualStereotype(text ne)= relax enddef;
	    Actor.dispatch("Dispatcher");
	    Actor.weng("Wayside Engineer");
	    Actor.teng("Train Engineer");
	    Actor.driver("Train Driver");
	    Actor.pass("Passengers");
	    % 
	    Usecase.uA("Dispatch Train");
	    Usecase.uB("Upload Schedule");
	    Usecase.uC("Close Track for", "Maintenance");
	    Usecase.uD("Toggle Switch", "for Testing");
	    Usecase.uE("Upload PLC");
	    Usecase.uF("Set Kp and Ki");
	    Usecase.uG("Set Target Velocity");
	    Usecase.uH("Apply Service Brake");
	    Usecase.uI("Turn Lights On and Off");
	    Usecase.uJ("Open and Close Doors");
	    Usecase.uK("Set Internal Temperature");
	    Usecase.uL("Apply Emergency Brake");
	    %
	    Component.System("System")(uA,uB,uC,uD,uE,uF,uG,uH,uI,uJ,uK,uL);
	    % 
	    topToBottom.left(10)(uA,uB,uC,uD,uE,uF,uG,uH,uI,uJ,uK,uL);
	    leftToRight(50)(dispatch, uA);
	    leftToRight(50)(weng, uE);
	    leftToRight(100)(uF, teng);
	    leftToRight(50)(driver, uG);
	    leftToRight(50)(pass, uL);
	    %
	    % 
	    drawObjects(dispatch,weng,teng,driver,pass,System,uA,uB,uC,uD,uE,uF,uG,uH,uI,uJ,uK,uL);
		%
	    link(association)(pathCut(dispatch, uA)(dispatch.e -- uA.w));
	    link(association)(pathCut(dispatch, uB)(dispatch.e -- uB.w));
	    link(association)(pathCut(dispatch, uC)(dispatch.e -- uC.w));
	    link(association)(pathCut(dispatch, uD)(dispatch.e -- uD.w));
	    %
	    link(association)(pathCut(weng, uE)(weng.e -- uE.w));
	    %
	    link(association)(pathCut(teng, uF)(teng.w -- uF.e));
	    %
	    link(association)(pathCut(driver, uG)(driver.e -- uG.w));
	    link(association)(pathCut(driver, uH)(driver.e -- uH.w));
	    link(association)(pathCut(driver, uI)(driver.e -- uI.w));
	    link(association)(pathCut(driver, uJ)(driver.e -- uJ.w));
	    link(association)(pathCut(driver, uK)(driver.e -- uK.w));
	    link(association)(pathCut(driver, uL)(driver.e -- uL.w));
	    %
	    link(association)(pathCut(pass, uL)(pass.e -- uL.w));
	    %
	\end{mpost}
}
\end{center}

\subsection{Use Case: Dispatch Train}
\begin{enumerate}
	\item Dispatcher clicks the "New Train" GUI button.
	\item Dispatcher fill the fields (block number, suggested speed, suggested authority, and destination block) and presses "Dispatch Train" GUI button.
	\item CTC will call the train model to create a new train and train controller.
	\item The train register itself with the track model.
	\item The dispatcher will now see a train on the specified block on the map.
\end{enumerate}

\subsection{Variant: Invalid Inputs}
\begin{enumerate}[label=\arabic*a., start=3]
	\item If the starting block is not next to the yard or an input is invalid, no train will be created and the invalid input will be outlined in red.
\end{enumerate}

\subsection{Use Case: Upload Schedule}
\begin{enumerate}
	\item Dispatcher selects "Upload Schedule" from the File menu.
	\item Dispatcher selects a schedule file on the computer.
	\item Schedule is parsed and is displayed by train to the dispatcher.
\end{enumerate}

\subsection{Variant: Unable to Read File}
\begin{enumerate}[label=\arabic*a., start=3]
	\item If the file could not be read, a popup will report the error to the dispatcher.
\end{enumerate}

\subsection{Use Case: Close Track for Maintenance}
\begin{enumerate}
	\item Dispatcher selects a block from the map.
	\item Dispatcher clicks "Close for Maintenance" GUI button.
	\item Block state displays "Maintenance" to the dispatcher
\end{enumerate}

\subsection{Use Case: Toggle Switch for Testing}
\begin{enumerate}
	\item Dispatcher selects a block with a switch from the map.
	\item Dispatcher clicks "Toggle Switch" GUI button.
	\item If wayside deems it safe, switch state will change and be displayed to the dispatcher.
\end{enumerate}


\section{Class Diagram}

\begin{center}
\resizebox{\textwidth}{!}{
	\begin{mpost}
		input metauml;
        % CTC
        Class.CTC("CTC")()(
            "init()",
            "..."
        );
        % Wayside
        Class.Wayside("Wayside")()(
            "init()",
            "..."
        );
	 	% Track Model
        Class.TrackModel("TrackModel")()(
            "init()",
            "..."
        );
        % Train Model
        Class.TrainModel("TrainModel")()(
            "init()",
            "..."
        );
        % Train Controller
        Class.TrainController("TrainController")()(
            "init()",
            "..."
        );
        % Environment
        Class.Environment("Environment")(
            "time",
            "temperature"
        )();
        % SimRunner
        Class.SimRunner("SimRunner")()(
            "main(args[])"
        );
        % Convert
        Class.Convert("Convert")()(
            "metersToFeet()",
            "..."
        );
        % BlockStatus
        Class.BlockStatus("BlockStatus")(
            "OPERATIONAL",
            "BROKEN",
            "..."
        )();
        % Suggestion
        Class.Suggestion("Suggestion")(
            "authority",
            "speed",
            "..."
        )();
        %
        leftToRight.top(30)(CTC, Wayside, TrackModel, TrainModel, TrainController);
        leftToRight(30)(Convert, BlockStatus, Suggestion);
        topToBottom(60)(Environment, Wayside);
        topToBottom(60)(SimRunner, TrainModel);
        topToBottom(60)(TrackModel, BlockStatus);
        % 
        drawObjects(CTC, Wayside, TrackModel, TrainModel, TrainController, Environment, SimRunner, Convert, BlockStatus, Suggestion);
        %
        % CTC, Wayside, TrackModel, TrainModel, TrainController, SimRunner ->  Environment
        link(associationUni)(CTC.n -- Environment.s);
        link(associationUni)(Wayside.n -- Environment.s);
        link(associationUni)(TrackModel.n -- Environment.s);
        link(associationUni)(TrainModel.n -- Environment.s);
        link(associationUni)(TrainController.n -- Environment.s);
        link(associationUni)(SimRunner.w -- Environment.e);
        % SimRunner -> CTC, Wayside, TrackModel, TrainModel, TrainController
        link(associationUni)(SimRunner.s -- CTC.n);
        link(associationUni)(SimRunner.s -- Wayside.n);
        link(associationUni)(SimRunner.s -- TrackModel.n);
        link(associationUni)(SimRunner.s -- TrainModel.n);
        link(associationUni)(SimRunner.s -- TrainController.n);
        % CTC <-> Wayside
        link(association)(CTC.e -- Wayside.w);
        % Wayside <-> TrackModel
        link(association)(Wayside.e -- TrackModel.w);
        % TrackModel <-> TrainModel
        link(association)(TrackModel.e -- TrainModel.w);
        % TrainModel <-> TrainController
        link(association)(TrainModel.e -- TrainController.w);
        % CTC, Wayside, TrackModel, TrainModel, TrainController ->  Convert
        link(associationUni)(CTC.s -- Convert.n);
        link(associationUni)(Wayside.s -- Convert.n);
        link(associationUni)(TrackModel.s -- Convert.n);
        link(associationUni)(TrainModel.s -- Convert.n);
        link(associationUni)(TrainController.s -- Convert.n);
        % CTC, Wayside ->  Suggestion
        link(associationUni)(CTC.s -- Suggestion.n);
        link(associationUni)(Wayside.s -- Suggestion.n);
        % CTC, Wayside, TrackModel ->  BlockStatus
        link(associationUni)(CTC.s -- BlockStatus.n);
        link(associationUni)(Wayside.s -- BlockStatus.n);
        link(associationUni)(TrackModel.s -- BlockStatus.n);
        % % StaticSwitch -> StaticBlock 1..3 
        % link(compositionUni)(pathStepX(StaticBlock.e, StaticSwitch.e, 30));
        % item(iAssoc)("1")(obj.nw = StaticSwitch.e + (15,0));
        % item(iAssoc)("3")(obj.nw = StaticBlock.e + (5,-5));
        % % TrackModel -> StaticSwitch 1..*
        % link(compositionUni)(pathStepX(StaticSwitch.e + (0,-20), TrackModel.e, 55));
        % item(iAssoc)("*")(obj.nw = StaticSwitch.e + (15,-20));
        % item(iAssoc)("1")(obj.nw = TrackModel.e + (5,-5));
        % % TrackModel -> StaticBlock 1..*
        % link(compositionUni)(pathStepX(StaticBlock.w, TrackModel.w, -25));
        % item(iAssoc)("*")(obj.nw = StaticBlock.w + (-20,0));
        % item(iAssoc)("1")(obj.nw = TrackModel.w + (-20,0));
        % % TrackModel -> Database 1..1
        % link(associationUni)(pathStepX(Database.n, TrackModel.s, 0));
        % item(iAssoc)("1")(obj.ne = TrackModel.s + (-5,-10));
        % item(iAssoc)("1")(obj.ne = Database.n + (0,10));
        % % StaticBlock -> StaticSwitch 1..0-1
        % link(associationUni)(pathStepX(StaticBlock.w + (0, -20), StaticSwitch.w, -25));
        % item(iAssoc)("1")(obj.nw = StaticBlock.w + (-20,-20));
        % item(iAssoc)("0..1")(obj.nw = StaticSwitch.w + (-20,-5));
	\end{mpost}
}
\end{center}

\section{Sequence Diagrams}

\subsection{Sequence Diagram: Initialize Simulation}
\begin{center}
\resizebox{\textwidth}{!}{
    \begin{sequencediagram}
    \newthread{sim}{SimRunner}
    \newinst{ctc}{CTC}
    \newinst{ws}{Wayside}
    \newinst{trackm}{TrackModel}
    \newinst{trainm}{TrainModel}
    \newinst{trainc}{TrainController}
    
    \begin{call}{sim}{init()}{trackm}{}
    \end{call}

    \begin{call}{sim}{init()}{ws}{}
    \end{call}

    \begin{call}{sim}{init()}{ctc}{}
    \end{call}

    \begin{call}{sim}{init()}{trainm}{}
    \end{call}

    \begin{call}{sim}{init()}{trainc}{}
    \end{call}

    \begin{sdblock}{Begin Simulation Loop}{}
        \begin{call}{sim}{...}{ctc}{}
        \end{call}
    \end{sdblock}
    \end{sequencediagram}
}
\end{center}

\subsection{Sequence Diagram: Run Simulation}
\begin{center}
\resizebox{!}{.9\textheight}{
    \begin{sequencediagram}
    \newthread{sim}{SimRunner}
    \newinst{ctc}{CTC}
    \newinst[3]{ws}{Wayside}
    \newinst[3]{trackm}{TrackModel}
    \newinst[3]{trainm}{TrainModel}
    \newinst[3]{trainc}{TrainController}
    
    \begin{call}{sim}{Increment Time}{sim}{}
    \end{call}

    \begin{call}{sim}{suggest()}{ctc}{}
        \begin{call}{ctc}{isOccupied(id)}{ws}{True/False}
            \begin{call}{ws}{isOccupied(id)}{trackm}{True/False}
                \begin{sdblock}{Update}{For Each Train}
                    \begin{call}{trackm}{getDisplacement(id)}{trainm}{displacement}
                        \begin{call}{trainm}{getPower()}{trainc}{power}
                            \begin{call}{trainc}{getSuggestedSpeed()}{trainm}{}
                                \begin{call}{trainm}{getSuggestedSpeed(id)}{trackm}{}
                                \end{call}
                            \end{call}
                            \begin{call}{trainc}{getSuggestedAuthority()}{trainm}{}
                                \begin{call}{trainm}{getSuggestedAuthority(id)}{trackm}{}
                                \end{call}
                            \end{call}
                            \begin{call}{trainc}{getBeacon()}{trainm}{}
                                \begin{call}{trainm}{getBeacon(id)}{trackm}{}
                                \end{call}
                            \end{call}
                            \begin{call}{trainc}{getBlockChange()}{trainm}{}
                                \begin{call}{trainm}{getBlockChange(id)}{trackm}{}
                                \end{call}
                            \end{call}
                        \end{call}
                    \end{call}
                \end{sdblock}
            \end{call}
        \end{call}
        \begin{sdblock}{Shallow Calls as Needed}{}
            \begin{call}{ctc}{getOccupancy(id), ...}{ws}{}
                \begin{call}{ws}{getOccupancy(id), ...()}{trackm}{}
                \end{call}
            \end{call}
        \end{sdblock}
        \begin{call}{ctc}{suggest(suggestions)}{ws}{}
            \begin{sdblock}{For Each Block}{}
                \begin{call}{ws}{setSpeed(...)}{trackm}{}
                \end{call}
                \begin{call}{ws}{setAuthority(...)}{trackm}{}
                \end{call}
                \begin{sdblock}{If a RR Crossing}{}
                    \begin{call}{ws}{setCrossingState(...)}{trackm}{}
                    \end{call}
                \end{sdblock}
            \end{sdblock}
            \begin{sdblock}{For Each Switch}{}
                \begin{call}{ws}{setSwitch(...)}{trackm}{}
                \end{call}
            \end{sdblock}
        \end{call}
    \end{call}
    \end{sequencediagram}
}
\end{center}

\subsection{Sequence Diagram: Dispatch Train}
\begin{center}
\resizebox{\textwidth}{!}{
 	\begin{sequencediagram}
	\newthread{disp}{Dispatcher}
	\newinst[1.8]{ctc}{CTCModel}
	%\newinst{ws}{Wayside}
	\newinst{tm}{TrackModel}
	\newinst[1.5]{train}{TrainModel}
	\newinst[2]{trainc}{TrainController}
	\newinst[1.5]{ui}{UI}
	
	\begin{call}{disp}{Dispatch Train}{ctc}{}
		\begin{call}{ctc}{createTrain(...)}{train}{}
			\begin{call}{train}{new TrainController()}{trainc}{}
				\begin{call}{trainc}{kp and ki popup}{ui}{}
				\end{call}
			\end{call}
			\begin{call}{train}{initializeTrain()}{tm}{}
			\end{call}
		\end{call}
	\end{call}
	\end{sequencediagram}
}
\end{center}

\subsection{Sequence Diagram: Dispatch Train (Variant: Invalid Inputs)}
\begin{center}
\resizebox{\textwidth}{!}{
 	\begin{sequencediagram}
	\newthread{disp}{Dispatcher}
	\newinst[1]{ctcgui}{CTCGUI}
	\newinst[8]{ctc}{CTCModel}
	%\newinst{ctcdat}{CTCTrainData}
	%\newinst{ws}{Wayside}
	%\newinst{tm}{TrackModel}
	%\newinst{train}{TrainModel}
	%\newinst{trainc}{TrainController}
	%\newinst{ui}{UI}
	
	\begin{call}{disp}{Dispatch Train}{ctcgui}{}
		\begin{call}{ctcgui}{checkTrainInputs(block, speed, authority, destination)}{ctc}{}
		\end{call}
	\end{call}
	
	\end{sequencediagram}
}
\end{center}

% THIS IS WHAT YOU WANT TO EDIT!
% ...if you want to include your own file in the full document.
% Include the name of your file - Without the ".tex"! - in a comment,
% and the contents of your file, after "\begin{document}", and 
% before "\end{document}" will be included.
% You want this comment to be on a line all alone,
% with no other text at all except the name of your file.
% YOU ALSO WANT TO MODIFY THE SCRIPT!
% Open up "scripts/splice.py" and follow the instructions there.
% ctc_model
% wayside
% track_model
% TrainModel
% train_controller

\end{document}